# Development

See: https://jupyter-ai.readthedocs.io/en/latest/contributors/index.html

## Pre-requisites

We highly recommend that you install conda to start developing on Jupyter AI.

### Creating conda environment

```bash
conda env create -f development/conda.yaml 
```

### Activating conda environment

```bash
conda activate stratio-jupyter-ai 
```

## Development install

This command must be run from the root of the monorepo (`<jupyter-ai-top>`).

```
# Move to the root of the repo package
cd <jupyter-ai-top>

# Installs all the dependencies and sets up the dev environment
./scripts/install.sh
```

Start and launch JupyterLab in your default browser:

```
jlpm dev
```

You can open a new terminal and use that to build and push changes to the repository. Enter the `conda` environment and build the project after making any changes.

```
cd <stratio-jupyter-ai-top>
conda activate stratio-jupyter-ai
jlpm build
```

To change what Jupyter AI packages are installed in your dev environment, use the `dev-uninstall` script:

```
# uninstalls all Jupyter AI packages
jlpm dev-uninstall
```

To reinstall Jupyter AI packages back into your dev environment, use the `dev-install` script:

```
# installs all Jupyter AI packages
jlpm dev-install
```

To only install/uninstall a subset of Jupyter AI packages, use the `--scope` argument that gets forwarded to Lerna:

```
# installs jupyter_ai_magics and its dependencies
jlpm dev-install --scope "@jupyter-ai/magics"
```

## Making changes while your server is running

If you change, add, or remove a **magic command**, after rebuilding, restart the kernel
or restart the server.

If you make changes to the **user interface** or **lab extension**, run `jlpm build` and then
refresh your browser tab.

## Building documentation

The `./scripts/install.sh` should automatically install the documentation
dependencies. To build the documentation locally, run

```
cd docs/
make html
```

and open `file://<JUPYTER-AI-ABSOLUTE-PATH>/docs/build/html/index.html`, where
`<JUPYTER-AI-ABSOLUTE-PATH>` is the absolute path of the Jupyter AI monorepo on
your local filesystem. It is helpful to bookmark this path in your browser of
choice to easily view your local documentation build.

After making any changes, make sure to rebuild the documentation locally via
`make html`, and then refresh your browser to verify the changes visually.


## Development uninstall

To uninstall your Jupyter AI development environment, deactivate and remove the Conda environment:

```
conda deactivate
conda remove --name stratio-jupyter-ai --all -y
```

## Testing

### Integration / E2E tests

This extension uses Playwright for the integration / E2E tests (user-level tests).
More precisely, the JupyterLab helper
[Galata](https://github.com/jupyterlab/jupyterlab/tree/master/galata) is used to
test the extension in JupyterLab.

Install test dependencies (needed only once):

```sh
cd ./packages/jupyter-ai/ui-tests/
jlpm install
jlpm playwright install
```

Tests involve snapshot comparisons against a reference snapshots generated by the Github CI. If you are using an OS other than Linux, you will need to generate local snapshots before running the tests locally for the first time. To do this, execute the command:

```sh
cd ./packages/jupyter-ai/ui-tests/
jlpm test:update
```

To execute tests, run:

```sh
cd ./packages/jupyter-ai/ui-tests/
jlpm test
```

You can find more information in the
[ui-tests](https://github.com/jupyterlab/jupyter-ai/tree/main/packages/jupyter-ai/ui-tests)
README.

